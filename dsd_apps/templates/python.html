{% load static %}
{% include 'header.html' %}

    <div class="section-switcher">
        <button onclick="loadSection('basic')" id="basic">Basic</button>
        <button onclick="loadSection('medium')" id="medium">Medium</button>
        <button onclick="loadSection('advanced')" id="advanced">Advanced</button>
    </div>

    <!-- Section Content that will change dynamically -->
    <div id="sectionContent">

    <!-- Modal for input -->
    <div id="inputModal" class="modal">
        <div class="modal-content">
            <h2 id="modalPromptMessage">Enter Input</h2>
            <input type="text" id="userInput" placeholder="Type your input here...">
            <button onclick="submitInput()">Submit</button>
        </div>
    </div>
    
    <script>
        const editors = {};
        let currentInputResolve = null;
    
        // Automatically load 'Basic' section on page load
        document.addEventListener("DOMContentLoaded", function() {
            loadSection('basic');  // Load the basic section by default

        });
    
        // AJAX function to load section dynamically
        function loadSection(section) {
            let sectionIntro = '';
            let topics = [];

            // Define section intro and multiple topics with relevant code
            if (section === 'basic') {
                document.querySelector("#basic").style.backgroundColor="green";
                document.querySelector("#advanced").style.backgroundColor=""
                document.querySelector("#medium").style.backgroundColor=""
                sectionIntro = `<h1>Python Basics</h1>
                                <p>Learn the basics of Python with examples. Here are multiple basic examples for you to explore.</p>`;
                topics = [
                    {
                        title: 'Hello World Example',
                        description: 'This is a simple "Hello, World!" program.',
                        code: `print("Hello, World!")`
                    },
                    {
                        title: 'Basic For Loop',
                        description: 'A basic loop that prints numbers from 0 to 4.',
                        code: `for i in range(5):\n    print(f"Number {i}")`
                    }
                ];
            } else if (section === 'medium') {
                document.querySelector("#medium").style.backgroundColor="green"
                document.querySelector("#basic").style.backgroundColor=""
                document.querySelector("#advanced").style.backgroundColor=""
                sectionIntro = `<h1>Medium Level Python</h1>
                                <p>This section covers medium-difficulty Python programs.</p>`;
                topics = [
                    {
                        title: 'Square of Numbers',
                        description: 'This program calculates the square of numbers from 1 to 5.',
                        code: `for i in range(1, 6):\n    print(f"Square of {i} is {i * i}")`
                    },
                    {
                        title: 'Conditional Statements',
                        description: 'A simple if-else conditional example.',
                        code: `number = 10\nif number > 5:\n    print("Number is greater than 5")\nelse:\n    print("Number is less than or equal to 5")`
                    }
                ];
            } else if (section === 'advanced') {
                document.querySelector("#advanced").style.backgroundColor="green"
                document.querySelector("#basic").style.backgroundColor=""
                document.querySelector("#medium").style.backgroundColor=""
                sectionIntro = `<h1>Advanced Python</h1>
                                <p>Explore advanced topics in Python like functions and recursion.</p>`;
                topics = [
                    {
                        title: 'Function Example',
                        description: 'This program defines and calls a function that greets the user.',
                        code: `def greet(name):\n    print(f"Hello, {name}!")\n\ngreet("Alice")`
                    },
                    {
                        title: 'Recursion Example',
                        description: 'A simple example demonstrating recursion in Python.',
                        code: `def factorial(n):\n    if n == 0:\n        return 1\n    else:\n        return n * factorial(n-1)\n\nprint(factorial(5))`
                    }
                ];
            }

            // Dispose of existing editors before loading the new section
            Object.keys(editors).forEach(editorId => {
                if (editors[editorId]) {
                    editors[editorId].dispose();
                    delete editors[editorId];  // Clean up editor instances
                }
            });

            // Create section content with multiple topics, each having its own compiler
            let sectionContent = `
                <div class="intro">
                    ${sectionIntro}
                </div>`;

            topics.forEach((topic, index) => {
                sectionContent += `
                    <div class="topic" style="heigth:500px">
                         <div style="width:50%;heigth:500px">
                        <h2>${topic.title}</h2>
                        <p>${topic.description}</p>
                        </div>
                        <div class="compiler" style="width:50%;heigth:500px">
                            <div id="editorContainer${index}" style="height: 200px; border: 1px solid #ccc;"></div>
                            <button onclick="runCode('editor${index}', 'output${index}')">Run</button>
                            <div class="output" id="output${index}" style="margin-top: 10px; background: #f4f4f4; padding: 10px;"></div>
                        </div>
                    </div>`;
            });

            // Insert the dynamically generated content into the page
            document.getElementById('sectionContent').innerHTML = sectionContent;

            // Ensure Monaco Editor is properly re-initialized for each topic
            require(['vs/editor/editor.main'], function () {
                topics.forEach((topic, index) => {
                    initializeEditor(`editor${index}`, topic.code);  // Re-initialize Monaco editor for each topic
                });
            });
        }

        // Monaco Editor setup using the provided JavaScript structure
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' }});
        require(['vs/editor/editor.main'], function () {
            initializeEditors();  // Initialize Monaco editors for the default section
        });
    
        // Function to initialize all Monaco Editor instances after loading new content
        function initializeEditors() {
            const editorContainers = document.querySelectorAll('[id^=editorContainer]');
            
            // Dispose of any existing editors before re-initializing
            Object.keys(editors).forEach(editorId => {
                if (editors[editorId]) {
                    editors[editorId].dispose();  // Dispose of the existing editor
                    delete editors[editorId];     // Remove from the editors object
                }
            });

            editorContainers.forEach(container => {
                const editorId = container.id.replace('editorContainer', 'editor');
                initializeEditor(editorId, '');  // Initialize editor with default empty value
            });
        }

    
        // Function to initialize a Monaco Editor instance
        function initializeEditor(editorId, defaultValue) {
            const container = document.getElementById(`editorContainer${editorId.slice(-1)}`);
            if (!editors[editorId]) {
                editors[editorId] = monaco.editor.create(container, {
                    value: defaultValue,
                    language: 'python',
                    theme: 'vs-dark',
                    automaticLayout: true
                });
            }
        }
    
        // Function to run the code
        async function runCode(editorId, outputId) {
            const editor = editors[editorId];
            let code = editor.getValue();
    
            // Detect and handle input() calls
            let inputs = [];
            let inputPattern = /input\((.*?)\)/g;
            let match;
    
            while ((match = inputPattern.exec(code)) !== null) {
                let userInput = await getInputFromUser(match[1] ? `Input required: ${match[1]}` : 'Enter input:');
                inputs.push(userInput || ''); // Handle cancel or empty inputs
            }
    
            try {
                let response = await fetch('/run/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({ 'code': code, 'inputs[]': inputs })  // Send inputs as array
                });
    
                let data = await response.json();
                document.getElementById(outputId).textContent = data.output || data.error;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById(outputId).textContent = 'Error executing code.';
            }
        }
    
        // Function to handle showing the modal for input
        function getInputFromUser(message) {
            return new Promise((resolve) => {
                document.getElementById('modalPromptMessage').textContent = message;
                document.getElementById('inputModal').style.display = 'flex';
                document.getElementById('userInput').value = '';  // Clear previous input
                currentInputResolve = resolve;  // Store the resolve function
            });
        }
    
        // Function to submit input from the modal
        function submitInput() {
            let input = document.getElementById('userInput').value;
            if (currentInputResolve) {
                currentInputResolve(input);
                currentInputResolve = null;
            }
            document.getElementById('inputModal').style.display = 'none';  // Hide modal after submitting
        }
    </script>
    
{% include 'footer.html' %}